<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#3498db" />
  <meta name="description" content="Flashcards Seznam - приложение для изучения чешских слов с помощью карточек" />
  <link rel="icon" href="/favicon.svg" type="image/svg+xml">
  <link rel="manifest" href="/manifest.json">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <title>Flashcards Seznam</title>

  <style>
    /* Основные стили CSS */
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --accent-color: #e74c3c;
      --light-color: #ecf0f1;
      --dark-color: #34495e;
      --success-color: #27ae60;
      --warning-color: #f39c12;
      --border-radius: 8px;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Roboto', 'Segoe UI', sans-serif;
      line-height: 1.6;
      color: var(--dark-color);
      background-color: var(--light-color);
    }

    .app {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
      padding: 20px;
      border-bottom: 2px solid var(--secondary-color);
    }

    .header h1 {
      color: var(--primary-color);
      font-size: 2.5rem;
      margin-bottom: 10px;
    }

    .subtitle {
      color: var(--dark-color);
      font-size: 1.2rem;
      font-weight: 300;
    }

    .main-content {
      background-color: white;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 30px;
      min-height: 500px;
    }

    .btn {
      display: inline-block;
      padding: 10px 20px;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
      text-align: center;
      transition: var(--transition);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-primary {
      background-color: var(--secondary-color);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background-color: #2980b9;
    }

    .btn-secondary {
      background-color: var(--light-color);
      color: var(--dark-color);
      border: 1px solid var(--dark-color);
    }

    .btn-secondary:hover:not(:disabled) {
      background-color: #dfe6e9;
    }

    .actions {
      margin-top: 20px;
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    .extracted-words {
      margin-bottom: 30px;
    }

    .extracted-words h2 {
      margin-bottom: 20px;
      text-align: center;
      color: var(--primary-color);
    }

    .words-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 30px;
    }

    .word-chip {
      background-color: var(--light-color);
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 0.9rem;
      border: 1px solid #bdc3c7;
      color: var(--dark-color);
      transition: var(--transition);
    }

    .word-chip:hover {
      background-color: var(--secondary-color);
      color: white;
      border-color: var(--secondary-color);
    }

    /* Стили для TextInput */
    .text-input {
      width: 100%;
      max-width: 800px;
      margin: 0 auto;
    }

    .text-input h2 {
      text-align: center;
      margin-bottom: 15px;
      color: var(--primary-color);
    }

    .instruction {
      text-align: center;
      margin-bottom: 20px;
      color: var(--dark-color);
      font-size: 1rem;
    }

    .text-area {
      width: 100%;
      min-height: 200px;
      padding: 15px;
      border-radius: var(--border-radius);
      border: 1px solid #bdc3c7;
      font-family: inherit;
      font-size: 1rem;
      resize: vertical;
      transition: var(--transition);
      margin-bottom: 20px;
    }

    .text-area:focus {
      outline: none;
      border-color: var(--secondary-color);
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
    }

    .text-input .btn {
      display: block;
      margin: 0 auto;
      min-width: 200px;
    }

    /* УЛУЧШЕННЫЕ стили для навигации */
    .flashcard-viewer {
      width: 100%;
      max-width: 900px;
      margin: 0 auto;
      padding: 30px 0;
    }

    .progress-info {
      text-align: center;
      margin-bottom: 25px;
      font-size: 1.3rem;
      color: var(--dark-color);
      font-weight: 500;
    }

    .card-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 30px;
      margin-bottom: 40px;
      min-height: 380px;
    }

    .nav-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      color: white;
      font-size: 2.5rem;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
      font-weight: bold;
    }

    .nav-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
      background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
    }

    .nav-btn:active {
      transform: translateY(-1px);
    }

    .nav-btn:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.4);
    }

    /* УЛУЧШЕННЫЕ точки прогресса */
    .card-progress {
      display: flex;
      justify-content: center;
      gap: 18px;
      margin-top: 30px;
      padding: 0 20px;
      position: relative;
    }

    .progress-dot {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background-color: #e0e0e0;
      border: 2px solid #bbb;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
      position: relative;
      z-index: 2;
    }

    .progress-dot:hover {
      background-color: #ccc;
      transform: scale(1.2);
    }

    .progress-dot.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-color: #667eea;
      transform: scale(1.4);
      box-shadow: 0 3px 10px rgba(102, 126, 234, 0.4);
    }
    
    /* Анимация перелистывания на точках */
    .card-progress::after {
      content: '';
      position: absolute;
      height: 4px;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      top: 50%;
      transform: translateY(-50%);
      left: calc(50% - 36px);
      right: calc(50% - 36px);
      z-index: 1;
      border-radius: 2px;
      transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
    }

    /* Анимация появления */
    .flashcard {
      animation: slideIn 0.6s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(30px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .no-cards {
      text-align: center;
      padding: 50px 0;
      font-size: 1.2rem;
      color: var(--dark-color);
    }

    /* УЛУЧШЕННЫЕ СТИЛИ ДЛЯ КАРТОЧЕК */

    /* Стили для Flashcard */
    .flashcard {
      perspective: 1500px;
      transition: transform 0.5s;
      cursor: pointer;
      width: 100%;
      max-width: 450px;
      height: 350px;
      margin: 0 auto;
    }

    .card-inner {
      position: relative;
      width: 100%;
      height: 100%;
      text-align: center;
      transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      transform-style: preserve-3d;
      box-shadow: 0 15px 35px rgba(50, 50, 93, 0.1), 0 5px 15px rgba(0, 0, 0, 0.07);
      border-radius: 15px;
    }

    .flashcard.flipped .card-inner {
      transform: rotateY(180deg);
    }
    
    /* Добавляем эффект при наведении */
    .flashcard:hover .card-inner {
      box-shadow: 0 20px 40px rgba(50, 50, 93, 0.15), 0 10px 20px rgba(0, 0, 0, 0.1);
    }
    
    .flashcard:hover .card-inner:not(.flipped) {
      transform: rotateY(15deg);
    }

    .card-front,
    .card-back {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 25px;
      border-radius: 15px;
      border: 2px solid transparent;
    }

    .card-front {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      /* Градиент */
      color: white;
      text-align: center;
    }

    .card-back {
      background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
      /* Более спокойный градиент */
      color: white;
      transform: rotateY(180deg);
      overflow-y: auto;
      align-items: flex-start;
      justify-content: flex-start;
      padding: 20px;
    }

    /* Стили для текста на лицевой стороне */
    .word {
      font-size: 3rem;
      /* Больше размер */
      margin-bottom: 20px;
      text-align: center;
      font-weight: 800;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      letter-spacing: 1px;
    }

    .hint {
      font-size: 1rem;
      opacity: 0.9;
      position: absolute;
      bottom: 20px;
      text-align: center;
      font-style: italic;
      font-weight: 300;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
    }

    /* Стили для обратной стороны */
    .original-word {
      font-size: 2.2rem;
      margin-bottom: 20px;
      color: white;
      text-align: center;
      width: 100%;
      font-weight: 700;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      border-bottom: 2px solid rgba(255, 255, 255, 0.3);
      padding-bottom: 10px;
    }

    /* УЛУЧШЕННЫЕ стили для переводов и примеров */
    .translations,
    .examples {
      width: 100%;
      margin-bottom: 20px;
    }

    .translations h4,
    .examples h4 {
      font-size: 1.3rem;
      margin-bottom: 12px;
      color: white;
      border-bottom: 2px solid rgba(255, 255, 255, 0.3);
      padding-bottom: 8px;
      font-weight: 600;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
    }

    .translations ul,
    .examples ul {
      list-style-type: none;
      padding: 0;
    }

    .translations li {
      margin-bottom: 12px;
      font-size: 1.2rem;
      font-weight: 500;
      color: #f8f9fa;
      padding: 10px 15px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      border-left: 4px solid rgba(255, 255, 255, 0.5);
      text-shadow: none;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .examples li {
      margin-bottom: 16px;
      background: rgba(255, 255, 255, 0.25);
      padding: 15px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
    }

    .sample-phrase {
      font-weight: 600;
      margin-bottom: 10px;
      color: #f8f9fa;
      font-size: 1.1rem;
      text-shadow: none;
      border-bottom: 1px dashed rgba(255, 255, 255, 0.3);
      padding-bottom: 5px;
    }

    .sample-translation {
      font-style: italic;
      color: #e9ecef;
      font-size: 1rem;
      line-height: 1.5;
      background: rgba(0, 0, 0, 0.1);
      padding: 8px 12px;
      border-radius: 6px;
    }

    .no-translations {
      color: rgba(255, 255, 255, 0.8);
      text-align: center;
      font-style: italic;
      padding: 20px;
      font-size: 1.1rem;
    }

    .note {
      font-size: 1rem;
      font-style: italic;
      color: rgba(255, 255, 255, 0.9);
      margin-top: 15px;
      text-align: center;
      padding: 10px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .attribution {
      font-size: 0.8rem;
      color: rgba(255, 255, 255, 0.7);
      position: absolute;
      bottom: 8px;
      right: 15px;
      font-style: italic;
    }

    .api-attribution {
      text-align: center;
      margin-top: 20px;
      font-size: 0.9rem;
      color: #999;
    }

    /* УЛУЧШЕННЫЙ блок нормализации */
    .normalization-info {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      padding: 12px 16px;
      border-radius: 12px;
      margin-bottom: 20px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      font-size: 0.9rem;
      width: 100%;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .normalization-info>div:first-child {
      font-size: 0.85rem !important;
      color: rgba(255, 255, 255, 0.9) !important;
      font-weight: 600 !important;
      margin-bottom: 6px !important;
    }

    .normalization-info>div:nth-child(2) {
      font-size: 1.1rem !important;
      color: white !important;
      font-weight: 700 !important;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
    }

    .normalization-info>div:last-child {
      font-size: 0.75rem !important;
      color: rgba(255, 255, 255, 0.8) !important;
      margin-top: 6px !important;
      font-style: italic;
    }

    .normalization-hint {
      font-size: 0.85rem;
      opacity: 0.9;
      margin-top: 10px;
      font-style: italic;
      color: rgba(255, 255, 255, 0.9);
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
    }

    /* Стили для индикатора прогресса */
    .progress-container {
      margin: 20px auto;
      max-width: 400px;
    }

    .progress-bar {
      height: 10px;
      background-color: #ecf0f1;
      border-radius: 5px;
      overflow: hidden;
      margin-bottom: 5px;
    }

    .progress-bar-fill {
      height: 100%;
      background-color: var(--secondary-color);
      border-radius: 5px;
      transition: width 0.3s ease;
    }

    .progress-text {
      font-size: 14px;
      color: #7f8c8d;
      text-align: center;
    }

    /* Стили для сообщений об ошибках */
    .error-message {
      color: var(--accent-color);
      text-align: center;
      margin: 15px 0;
      padding: 10px;
      border: 1px solid var(--accent-color);
      border-radius: var(--border-radius);
      background-color: rgba(231, 76, 60, 0.1);
    }

    /* Новые стили для управления словарем */
    .dictionary-stats {
      margin-top: 30px;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: var(--border-radius);
      text-align: center;
    }

    .dictionary-button {
      margin-left: 10px;
      padding: 8px 15px;
      background-color: var(--secondary-color);
      color: white;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 0.9rem;
    }

    .dictionary-view {
      margin-top: 20px;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
      padding: 15px;
    }

    .dict-word-item {
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }

    .dict-word {
      font-weight: 500;
      color: var(--primary-color);
    }

    .dict-translations {
      margin-left: 15px;
      font-size: 0.9rem;
    }

    /* Загрузочный индикатор */
    .loading {
      text-align: center;
      padding: 20px;
      color: var(--dark-color);
    }

    /* Адаптивные стили для мобильных */
    @media screen and (max-width: 768px) {
      .app {
        padding: 10px;
      }

      .header h1 {
        font-size: 2rem;
      }

      .main-content {
        padding: 20px;
      }

      .words-container {
        justify-content: center;
      }

      .text-area {
        min-height: 150px;
      }

      .flashcard {
        max-width: 350px;
        height: 320px;
      }

      .word {
        font-size: 2.5rem;
      }

      .original-word {
        font-size: 1.8rem;
      }

      .card-container {
        flex-direction: column;
        gap: 20px;
      }

      .nav-btn {
        width: 50px;
        height: 50px;
        font-size: 2rem;
      }

      .progress-dot {
        width: 12px;
        height: 12px;
      }

      .card-progress {
        gap: 8px;
      }

      .normalization-info {
        padding: 10px 12px;
        font-size: 0.85rem;
      }

      .translations h4,
      .examples h4 {
        font-size: 1.1rem;
      }

      .translations li {
        font-size: 1rem;
        padding: 6px 10px;
      }

      .sample-phrase {
        font-size: 1rem;
      }

      .sample-translation {
        font-size: 0.9rem;
      }
    }
  </style>
</head>

<body>
  <noscript>Для работы приложения необходимо включить JavaScript.</noscript>
  <div id="root">
    <div class="loading">Загрузка приложения...</div>
  </div>

  <!-- React из CDN для продакшена -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Firebase SDK v9 -->
  <script type="module">
    // Импорт Firebase SDK из CDN  
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js';
    import { getDatabase, ref, set, get } from 'https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js';

    // Исправленная Firebase конфигурация БЕЗ ANALYTICS
    const firebaseConfig = {
      apiKey: "AIzaSyAPZIHxaLt92McIvbIcYE-tSYp2Li2jxs4",
      authDomain: "flashcards-seznam-6652a.firebaseapp.com",
      projectId: "flashcards-seznam-6652a",
      storageBucket: "flashcards-seznam-6652a.firebasestorage.app",
      messagingSenderId: "99460986155",
      appId: "1:99460986155:web:e5ca466e3d07c20cde016e",
      // Исправленный URL базы данных БЕЗ слэша в конце
      databaseURL: "https://flashcards-seznam-6652a-default-rtdb.europe-west1.firebasedatabase.app"
    };

    // Инициализируем Firebase
    let app, database;

    try {
      console.log('Инициализация Firebase...');
      app = initializeApp(firebaseConfig);
      database = getDatabase(app);

      console.log('Firebase успешно инициализирован');

      // Простая проверка соединения БЕЗ .info/connected 
      const testRef = ref(database, 'test');
      get(testRef).then(() => {
        console.log('Соединение с Firebase Database установлено');
      }).catch((error) => {
        console.warn('Проблема с соединением Firebase Database:', error);
      });

    } catch (error) {
      console.error('Ошибка инициализации Firebase:', error);
      // Создаем заглушки для работы в offline режиме
      database = null;
    }

    // Делаем Firebase доступным глобально
    window.firebaseApp = app;
    window.firebaseDB = database;
    window.firebaseRef = ref;
    window.firebaseSet = set;
    window.firebaseGet = get;
  </script>

  <!-- 🔥 ПОЛНАЯ СИСТЕМА НОРМАЛИЗАЦИИ ЧЕШСКИХ СЛОВ -->
  <script>
    // ПОЛНАЯ система нормализации чешских слов
    class CzechNormalizer {
      constructor() {
        // Словарь исключений - неправильные формы
        this.exceptions = {
          // Неправильные глаголы
          'jsem': 'být', 'jsi': 'být', 'je': 'být', 'jsme': 'být', 'jste': 'být', 'jsou': 'být',
          'byl': 'být', 'byla': 'být', 'bylo': 'být', 'byli': 'být', 'byly': 'být',
          'mám': 'mít', 'máš': 'mít', 'má': 'mít', 'máme': 'mít', 'máte': 'mít', 'mají': 'mít',
          'měl': 'mít', 'měla': 'mít', 'měli': 'mít', 'měly': 'mít',
          'jdu': 'jít', 'jdeš': 'jít', 'jde': 'jít', 'jdeme': 'jít', 'jdete': 'jít', 'jdou': 'jít',
          'šel': 'jít', 'šla': 'jít', 'šli': 'jít', 'šly': 'jít',
          'vím': 'vědět', 'víš': 'vědět', 'ví': 'vědět', 'víme': 'vědět', 'víte': 'vědět', 'vědí': 'vědět',
          'věděl': 'vědět', 'věděla': 'vědět',

          // Неправильные существительные
          'lidé': 'člověk', 'lidí': 'člověk', 'lidem': 'člověk', 'lidi': 'člověk', 'lidech': 'člověk', 'lidmi': 'člověk',
          'děti': 'dítě', 'dětí': 'dítě', 'dětem': 'dítě', 'dětmi': 'dítě', 'dětech': 'dítě',
          'oči': 'oko', 'očí': 'oko', 'očím': 'oko', 'očima': 'oko', 'očích': 'oko',
          'uši': 'ucho', 'uší': 'ucho', 'uším': 'ucho', 'ušima': 'ucho', 'uších': 'ucho',

          // Степени сравнения
          'lepší': 'dobrý', 'nejlepší': 'dobrý',
          'horší': 'špatný', 'nejhorší': 'špatný',
          'větší': 'velký', 'největší': 'velký',
          'menší': 'malý', 'nejmenší': 'malý',
          'starší': 'starý', 'nejstarší': 'starý',
          'mladší': 'mladý', 'nejmladší': 'mladý'
        };

        // ПОЛНЫЕ правила нормализации
        this.normalizationRules = [
          // ============================================================================
          // ПРИТЯЖАТЕЛЬНЫЕ МЕСТОИМЕНИЯ (высший приоритет)
          // ============================================================================

          // Мое/моя/мои
          { pattern: /^mého$/, replacements: ['můj'], type: 'possessive', priority: 10 },
          { pattern: /^mému$/, replacements: ['můj'], type: 'possessive', priority: 10 },
          { pattern: /^mým$/, replacements: ['můj'], type: 'possessive', priority: 10 },
          { pattern: /^mých$/, replacements: ['můj'], type: 'possessive', priority: 10 },
          { pattern: /^mými$/, replacements: ['můj'], type: 'possessive', priority: 10 },
          { pattern: /^mojí$/, replacements: ['můj'], type: 'possessive', priority: 10 },
          { pattern: /^moji$/, replacements: ['můj'], type: 'possessive', priority: 10 },
          { pattern: /^moje$/, replacements: ['můj'], type: 'possessive', priority: 10 },
          { pattern: /^mou$/, replacements: ['můj'], type: 'possessive', priority: 10 },

          // Твое/твоя/твои
          { pattern: /^tvého$/, replacements: ['tvůj'], type: 'possessive', priority: 10 },
          { pattern: /^tvému$/, replacements: ['tvůj'], type: 'possessive', priority: 10 },
          { pattern: /^tvým$/, replacements: ['tvůj'], type: 'possessive', priority: 10 },
          { pattern: /^tvých$/, replacements: ['tvůj'], type: 'possessive', priority: 10 },
          { pattern: /^tvými$/, replacements: ['tvůj'], type: 'possessive', priority: 10 },
          { pattern: /^tvoji$/, replacements: ['tvůj'], type: 'possessive', priority: 10 },
          { pattern: /^tvoje$/, replacements: ['tvůj'], type: 'possessive', priority: 10 },
          { pattern: /^tvou$/, replacements: ['tvůj'], type: 'possessive', priority: 10 },

          // Наше/наша/наши
          { pattern: /^našich$/, replacements: ['náš'], type: 'possessive', priority: 10 },
          { pattern: /^naší$/, replacements: ['náš'], type: 'possessive', priority: 10 },
          { pattern: /^našemu$/, replacements: ['náš'], type: 'possessive', priority: 10 },
          { pattern: /^naším$/, replacements: ['náš'], type: 'possessive', priority: 10 },
          { pattern: /^našimi$/, replacements: ['náš'], type: 'possessive', priority: 10 },
          { pattern: /^naše$/, replacements: ['náš'], type: 'possessive', priority: 10 },
          { pattern: /^našeho$/, replacements: ['náš'], type: 'possessive', priority: 10 },
          { pattern: /^naši$/, replacements: ['náš'], type: 'possessive', priority: 10 },

          // Ваше/ваша/ваши
          { pattern: /^vašich$/, replacements: ['váš'], type: 'possessive', priority: 10 },
          { pattern: /^vaší$/, replacements: ['váš'], type: 'possessive', priority: 10 },
          { pattern: /^vašemu$/, replacements: ['váš'], type: 'possessive', priority: 10 },
          { pattern: /^vaším$/, replacements: ['váš'], type: 'possessive', priority: 10 },
          { pattern: /^vašimi$/, replacements: ['váš'], type: 'possessive', priority: 10 },
          { pattern: /^vaše$/, replacements: ['váš'], type: 'possessive', priority: 10 },
          { pattern: /^vašeho$/, replacements: ['váš'], type: 'possessive', priority: 10 },
          { pattern: /^vaši$/, replacements: ['váš'], type: 'possessive', priority: 10 },

          // ============================================================================
          // ЛИЧНЫЕ МЕСТОИМЕНИЯ
          // ============================================================================

          // Он/она/оно
          { pattern: /^něho$/, replacements: ['on'], type: 'pronoun', priority: 9 },
          { pattern: /^něj$/, replacements: ['on'], type: 'pronoun', priority: 9 },
          { pattern: /^němu$/, replacements: ['on'], type: 'pronoun', priority: 9 },
          { pattern: /^ním$/, replacements: ['on'], type: 'pronoun', priority: 9 },
          { pattern: /^něm$/, replacements: ['on'], type: 'pronoun', priority: 9 },
          { pattern: /^jemu$/, replacements: ['on'], type: 'pronoun', priority: 9 },
          { pattern: /^jím$/, replacements: ['on'], type: 'pronoun', priority: 9 },

          { pattern: /^ní$/, replacements: ['ona'], type: 'pronoun', priority: 9 },
          { pattern: /^jí$/, replacements: ['ona'], type: 'pronoun', priority: 9 },
          { pattern: /^ji$/, replacements: ['ona'], type: 'pronoun', priority: 9 },
          { pattern: /^ně$/, replacements: ['ona'], type: 'pronoun', priority: 9 },

          // Мы/вы/они
          { pattern: /^nás$/, replacements: ['my'], type: 'pronoun', priority: 9 },
          { pattern: /^nám$/, replacements: ['my'], type: 'pronoun', priority: 9 },
          { pattern: /^námi$/, replacements: ['my'], type: 'pronoun', priority: 9 },

          { pattern: /^vás$/, replacements: ['vy'], type: 'pronoun', priority: 9 },
          { pattern: /^vám$/, replacements: ['vy'], type: 'pronoun', priority: 9 },
          { pattern: /^vámi$/, replacements: ['vy'], type: 'pronoun', priority: 9 },

          { pattern: /^nich$/, replacements: ['oni'], type: 'pronoun', priority: 9 },
          { pattern: /^nimi$/, replacements: ['oni'], type: 'pronoun', priority: 9 },
          { pattern: /^jim$/, replacements: ['oni'], type: 'pronoun', priority: 9 },

          // ============================================================================
          // УКАЗАТЕЛЬНЫЕ МЕСТОИМЕНИЯ  
          // ============================================================================

          // Ten/ta/to
          { pattern: /^toho$/, replacements: ['ten'], type: 'demonstrative', priority: 8 },
          { pattern: /^tomu$/, replacements: ['ten'], type: 'demonstrative', priority: 8 },
          { pattern: /^tom$/, replacements: ['ten'], type: 'demonstrative', priority: 8 },
          { pattern: /^tím$/, replacements: ['ten'], type: 'demonstrative', priority: 8 },
          { pattern: /^té$/, replacements: ['ten'], type: 'demonstrative', priority: 8 },
          { pattern: /^tu$/, replacements: ['ten'], type: 'demonstrative', priority: 8 },
          { pattern: /^tou$/, replacements: ['ten'], type: 'demonstrative', priority: 8 },
          { pattern: /^těch$/, replacements: ['ten'], type: 'demonstrative', priority: 8 },
          { pattern: /^těm$/, replacements: ['ten'], type: 'demonstrative', priority: 8 },
          { pattern: /^těmi$/, replacements: ['ten'], type: 'demonstrative', priority: 8 },
          { pattern: /^ty$/, replacements: ['ten', 'ty'], type: 'demonstrative', priority: 8 },

          // Tento/tato/toto
          { pattern: /^tohoto$/, replacements: ['tento'], type: 'demonstrative', priority: 8 },
          { pattern: /^tomuto$/, replacements: ['tento'], type: 'demonstrative', priority: 8 },
          { pattern: /^tomto$/, replacements: ['tento'], type: 'demonstrative', priority: 8 },
          { pattern: /^tímto$/, replacements: ['tento'], type: 'demonstrative', priority: 8 },
          { pattern: /^této$/, replacements: ['tento'], type: 'demonstrative', priority: 8 },
          { pattern: /^tuto$/, replacements: ['tento'], type: 'demonstrative', priority: 8 },
          { pattern: /^touto$/, replacements: ['tento'], type: 'demonstrative', priority: 8 },
          { pattern: /^těchto$/, replacements: ['tento'], type: 'demonstrative', priority: 8 },
          { pattern: /^těmto$/, replacements: ['tento'], type: 'demonstrative', priority: 8 },
          { pattern: /^těmito$/, replacements: ['tento'], type: 'demonstrative', priority: 8 },
          { pattern: /^tyto$/, replacements: ['tento'], type: 'demonstrative', priority: 8 },

          // ============================================================================
          // ЧИСЛИТЕЛЬНЫЕ
          // ============================================================================

          { pattern: /^jednoho$/, replacements: ['jeden'], type: 'numeral', priority: 7 },
          { pattern: /^jednom$/, replacements: ['jeden'], type: 'numeral', priority: 7 },
          { pattern: /^jedním$/, replacements: ['jeden'], type: 'numeral', priority: 7 },
          { pattern: /^jedné$/, replacements: ['jeden'], type: 'numeral', priority: 7 },
          { pattern: /^jednu$/, replacements: ['jeden'], type: 'numeral', priority: 7 },
          { pattern: /^jednou$/, replacements: ['jeden'], type: 'numeral', priority: 7 },
          { pattern: /^jedni$/, replacements: ['jeden'], type: 'numeral', priority: 7 },
          { pattern: /^jedny$/, replacements: ['jeden'], type: 'numeral', priority: 7 },

          { pattern: /^dvou$/, replacements: ['dva'], type: 'numeral', priority: 7 },
          { pattern: /^dvěma$/, replacements: ['dva'], type: 'numeral', priority: 7 },

          { pattern: /^tří$/, replacements: ['tři'], type: 'numeral', priority: 7 },
          { pattern: /^třem$/, replacements: ['tři'], type: 'numeral', priority: 7 },
          { pattern: /^třemi$/, replacements: ['tři'], type: 'numeral', priority: 7 },

          { pattern: /^čtyř$/, replacements: ['čtyři'], type: 'numeral', priority: 7 },
          { pattern: /^čtyřem$/, replacements: ['čtyři'], type: 'numeral', priority: 7 },
          { pattern: /^čtyřmi$/, replacements: ['čtyři'], type: 'numeral', priority: 7 },

          { pattern: /^pěti$/, replacements: ['pět'], type: 'numeral', priority: 7 },
          { pattern: /^šesti$/, replacements: ['šest'], type: 'numeral', priority: 7 },
          { pattern: /^sedmi$/, replacements: ['sedm'], type: 'numeral', priority: 7 },
          { pattern: /^osmi$/, replacements: ['osm'], type: 'numeral', priority: 7 },
          { pattern: /^devíti$/, replacements: ['devět'], type: 'numeral', priority: 7 },
          { pattern: /^deseti$/, replacements: ['deset'], type: 'numeral', priority: 7 },

          // ============================================================================
          // ГЛАГОЛЬНЫЕ ПРАВИЛА
          // ============================================================================

          // Специфичные глагольные окончания
          { pattern: /ujeme$/, replacements: ['ovat', 'it'], type: 'verb' },
          { pattern: /ujete$/, replacements: ['ovat', 'it'], type: 'verb' },
          { pattern: /ují$/, replacements: ['ovat', 'it'], type: 'verb' },
          { pattern: /uji$/, replacements: ['ovat', 'it'], type: 'verb' },
          { pattern: /uješ$/, replacements: ['ovat', 'it'], type: 'verb' },

          // Настоящее время - 1-е спряжение (-at глаголы)
          { pattern: /eme$/, replacements: ['at'], type: 'verb' },
          { pattern: /ete$/, replacements: ['at'], type: 'verb' },
          { pattern: /ají$/, replacements: ['at'], type: 'verb' },
          { pattern: /ám$/, replacements: ['at'], type: 'verb' },
          { pattern: /áš$/, replacements: ['at'], type: 'verb' },
          { pattern: /á$/, replacements: ['at'], type: 'verb' },

          // Настоящее время - 2-е спряжение (-et глаголы)
          { pattern: /íme$/, replacements: ['ět'], type: 'verb' },
          { pattern: /íte$/, replacements: ['ět'], type: 'verb' },
          { pattern: /í$/, replacements: ['ět'], type: 'verb' },
          { pattern: /ím$/, replacements: ['ět'], type: 'verb' },
          { pattern: /íš$/, replacements: ['ět'], type: 'verb' },

          // Настоящее время - 3-е спряжение (-it глаголы)
          { pattern: /íme$/, replacements: ['it'], type: 'verb' },
          { pattern: /íte$/, replacements: ['it'], type: 'verb' },
          { pattern: /í$/, replacements: ['it'], type: 'verb' },
          { pattern: /ím$/, replacements: ['it'], type: 'verb' },
          { pattern: /íš$/, replacements: ['it'], type: 'verb' },

          // Прошедшее время
          { pattern: /oval$/, replacements: ['ovat'], type: 'verb' },
          { pattern: /ovala$/, replacements: ['ovat'], type: 'verb' },
          { pattern: /ovalo$/, replacements: ['ovat'], type: 'verb' },
          { pattern: /ovali$/, replacements: ['ovat'], type: 'verb' },
          { pattern: /ovaly$/, replacements: ['ovat'], type: 'verb' },

          { pattern: /al$/, replacements: ['at'], type: 'verb' },
          { pattern: /ala$/, replacements: ['at'], type: 'verb' },
          { pattern: /alo$/, replacements: ['at'], type: 'verb' },
          { pattern: /ali$/, replacements: ['at'], type: 'verb' },
          { pattern: /aly$/, replacements: ['at'], type: 'verb' },

          { pattern: /el$/, replacements: ['ět', 'it'], type: 'verb' },
          { pattern: /ěla$/, replacements: ['ět'], type: 'verb' },
          { pattern: /ělo$/, replacements: ['ět'], type: 'verb' },
          { pattern: /ěli$/, replacements: ['ět'], type: 'verb' },
          { pattern: /ěly$/, replacements: ['ět'], type: 'verb' },

          { pattern: /il$/, replacements: ['it'], type: 'verb' },
          { pattern: /ila$/, replacements: ['it'], type: 'verb' },
          { pattern: /ilo$/, replacements: ['it'], type: 'verb' },
          { pattern: /ili$/, replacements: ['it'], type: 'verb' },
          { pattern: /ily$/, replacements: ['it'], type: 'verb' },

          // Повелительное наклонение
          { pattern: /ej$/, replacements: ['at'], type: 'verb' },
          { pattern: /ejte$/, replacements: ['at'], type: 'verb' },
          { pattern: /ějme$/, replacements: ['at'], type: 'verb' },
          { pattern: /ujte$/, replacements: ['it', 'ovat'], type: 'verb' },
          { pattern: /ujme$/, replacements: ['it', 'ovat'], type: 'verb' },

          // Причастия и деепричастия
          { pattern: /ující$/, replacements: ['it', 'ovat'], type: 'verb' },
          { pattern: /ající$/, replacements: ['at'], type: 'verb' },
          { pattern: /ící$/, replacements: ['it', 'ět'], type: 'verb' },
          { pattern: /ený$/, replacements: ['it'], type: 'verb' },
          { pattern: /aný$/, replacements: ['at'], type: 'verb' },
          { pattern: /ovaný$/, replacements: ['ovat'], type: 'verb' },

          // ============================================================================
          // ПРАВИЛА ДЛЯ ПРИЛАГАТЕЛЬНЫХ
          // ============================================================================

          // Мужской род твердого склонения
          { pattern: /ého$/, replacements: ['ý'], type: 'adj' },
          { pattern: /ému$/, replacements: ['ý'], type: 'adj' },
          { pattern: /ým$/, replacements: ['ý'], type: 'adj' },
          { pattern: /ých$/, replacements: ['ý'], type: 'adj' },
          { pattern: /ými$/, replacements: ['ý'], type: 'adj' },
          { pattern: /é$/, replacements: ['ý'], type: 'adj' },

          // Мужской род мягкого склонения
          { pattern: /ího$/, replacements: ['í'], type: 'adj' },
          { pattern: /ímu$/, replacements: ['í'], type: 'adj' },
          { pattern: /ím$/, replacements: ['í'], type: 'adj' },
          { pattern: /ích$/, replacements: ['í'], type: 'adj' },
          { pattern: /ími$/, replacements: ['í'], type: 'adj' },

          // Женский род твердого склонения
          { pattern: /ou$/, replacements: ['á'], type: 'adj' },
          { pattern: /ických$/, replacements: ['ický'], type: 'adj' },
          { pattern: /ickou$/, replacements: ['ický'], type: 'adj' },
          { pattern: /skou$/, replacements: ['ský'], type: 'adj' },
          { pattern: /nou$/, replacements: ['ný'], type: 'adj' },

          // ============================================================================
          // ПРАВИЛА ДЛЯ СУЩЕСТВИТЕЛЬНЫХ
          // ============================================================================

          // Мужской род твердого склонения
          { pattern: /ové$/, replacements: [''], type: 'noun' },
          { pattern: /ů$/, replacements: [''], type: 'noun' },
          { pattern: /em$/, replacements: [''], type: 'noun' },
          { pattern: /ech$/, replacements: [''], type: 'noun' },
          { pattern: /y$/, replacements: [''], type: 'noun', exclude: ['kdy', 'proč', 'aby', 'když', 'ty'] },

          // Мужской род мягкого склонения
          { pattern: /ích$/, replacements: [''], type: 'noun' },
          { pattern: /i$/, replacements: [''], type: 'noun', exclude: ['jakékoli', 'několi', 'nikoli', 'dokoli', 'říci', 'oni', 'ti'] },

          // Женский род твердого склонения
          { pattern: /ách$/, replacements: ['a'], type: 'noun' },
          { pattern: /ami$/, replacements: ['a'], type: 'noun' },
          { pattern: /ě$/, replacements: ['a'], type: 'noun' },
          { pattern: /u$/, replacements: ['a'], type: 'noun' },
          { pattern: /y$/, replacements: ['a'], type: 'noun' },

          // Женский род мягкого склонения  
          { pattern: /í$/, replacements: ['e'], type: 'noun' },
          { pattern: /ích$/, replacements: ['e'], type: 'noun' },
          { pattern: /emi$/, replacements: ['e'], type: 'noun' },

          // Средний род твердого склонения
          { pattern: /a$/, replacements: ['o'], type: 'noun' },
          { pattern: /ech$/, replacements: ['o'], type: 'noun' },
          { pattern: /y$/, replacements: ['o'], type: 'noun' },

          // Средний род мягкого склонения
          { pattern: /í$/, replacements: ['e'], type: 'noun' },
          { pattern: /ích$/, replacements: ['e'], type: 'noun' },

          // ============================================================================
          // ЧЕРЕДОВАНИЯ СОГЛАСНЫХ (применяем последними)
          // ============================================================================
          { pattern: /ce$/, replacements: ['k'], type: 'alternation' },
          { pattern: /ze$/, replacements: ['h'], type: 'alternation' },
          { pattern: /še$/, replacements: ['ch'], type: 'alternation' },
          { pattern: /ně$/, replacements: ['n'], type: 'alternation' },
          { pattern: /ře$/, replacements: ['r'], type: 'alternation' },
          { pattern: /ďe$/, replacements: ['d'], type: 'alternation' },
          { pattern: /ťe$/, replacements: ['t'], type: 'alternation' },

          // Чередования в корне
          { pattern: /ck$/, replacements: ['k'], type: 'alternation' },
          { pattern: /ž$/, replacements: ['h'], type: 'alternation' },
          { pattern: /š$/, replacements: ['ch'], type: 'alternation' },
          { pattern: /ň$/, replacements: ['n'], type: 'alternation' },
          { pattern: /ř$/, replacements: ['r'], type: 'alternation' },
          { pattern: /ď$/, replacements: ['d'], type: 'alternation' },
          { pattern: /ť$/, replacements: ['t'], type: 'alternation' },
        ];

        // Сортируем правила по приоритету (специальные случаи первыми)
        this.normalizationRules.sort((a, b) => (b.priority || 0) - (a.priority || 0));
      }

      // УЛУЧШЕННАЯ функция нормализации
      normalize(word) {
        if (!word || typeof word !== 'string') {
          return [word];
        }

        const originalWord = word;
        word = word.toLowerCase().trim();

        console.log(`🔍 Нормализация слова: "${originalWord}"`);

        // 1. Проверяем словарь исключений
        if (this.exceptions[word]) {
          console.log(`📋 Исключение: ${originalWord} → ${this.exceptions[word]}`);
          return [this.exceptions[word]];
        }

        // 2. Собираем ВСЕ возможные варианты нормализации
        const candidates = new Set();
        candidates.add(word); // Исходное слово всегда первое

        // Применяем все подходящие правила
        for (const rule of this.normalizationRules) {
          if (rule.pattern.test(word)) {
            // Проверяем исключения для правила
            if (rule.exclude && rule.exclude.includes(word)) {
              console.log(`⚠️ Пропускаем правило ${rule.type} для "${word}" (в списке исключений)`);
              continue;
            }

            for (const replacement of rule.replacements) {
              const normalized = word.replace(rule.pattern, replacement);
              if (normalized !== word && normalized.length > 0) {
                candidates.add(normalized);
                console.log(`✅ Правило ${rule.type} (приоритет ${rule.priority || 0}): ${originalWord} → ${normalized}`);
              }
            }
          }
        }

        // 3. Дополнительная нормализация для прилагательных
        const candidatesArray = Array.from(candidates);
        for (const candidate of candidatesArray) {
          const nounForm = this.adjToNoun(candidate);
          if (nounForm && nounForm !== candidate) {
            candidates.add(nounForm);
            console.log(`🔄 Прилагательное → существительное: ${candidate} → ${nounForm}`);
          }
        }

        const result = Array.from(candidates);
        console.log(`📝 Финальные варианты для "${originalWord}": [${result.join(', ')}]`);
        return result;
      }

      // Преобразование прилагательного в существительное
      adjToNoun(adjective) {
        const adjToNounMap = {
          // Основные прилагательные → существительные
          'zákaznický': 'zákazník',
          'městský': 'město',
          'školní': 'škola',
          'rodinný': 'rodina',
          'státní': 'stát',
          'národní': 'národ',
          'evropský': 'evropa',
          'český': 'čechy',
          'ruský': 'rusko',
          'americký': 'amerika',
          'finanční': 'finance',
          'technický': 'technika',
          'politický': 'politika',
          'ekonomický': 'ekonomie',
          'sociální': 'společnost',
          'kulturní': 'kultura',
          'sportovní': 'sport',
          'obchodní': 'obchod',
          'průmyslový': 'průmysl',
          'zemědělský': 'zemědělství',

          // Дополнительные
          'pracovní': 'práce',
          'domácí': 'dům',
          'lidský': 'člověk',
          'světový': 'svět',
          'životní': 'život',
          'časový': 'čas',
          'denní': 'den',
          'noční': 'noc',
          'ranní': 'ráno',
          'večerní': 'večer',
          'roční': 'rok',
          'měsíční': 'měsíc',
          'týdenní': 'týden',
          'hodný': 'hodnota',
          'cenný': 'cena',
          'kvalitní': 'kvalita',
          'bezpečný': 'bezpečnost',
          'zdravý': 'zdraví',
          'mladý': 'mládí',
          'starý': 'stáří',
          'osobní': 'osoba',
          'veřejný': 'veřejnost',
          'soukromý': 'soukromí',
          'právní': 'právo',
          'vojenský': 'vojsko',
          'policejní': 'policie',
          'lékařský': 'lékař',
          'učitelský': 'učitel',
          'studentský': 'student',
          'dětský': 'dítě',
          'ženský': 'žena',
          'mužský': 'muž'
        };

        return adjToNounMap[adjective] || null;
      }

      // Функция для тестирования нормализации
      test() {
        const testCases = [
          'našich',         // náš (притяжательное местоимение)
          'doporučujeme',   // doporučovat/doporučit (глагол)
          'kladených',      // kladený → klást (прилагательное → глагол)
          'zákaznickou',    // zákaznický → zákazník (прилагательное → существительное)
          'dotazů',         // dotaz (существительное Р.п. мн.ч.)
          'prosíme',        // prosit (глагол 1 л. мн.ч.)
          'směřujte',       // směřovat/směřit (глагол повелит. накл.)
          'jakékoli',       // jakýkoli (через исключения)
          'toho',           // ten (указательное местоимение)
          'tohoto',         // tento (указательное местоимение)
          'jednoho',        // jeden (числительное)
          'dvou',           // dva (числительное)
          'mého',           // můj (притяжательное местоимение)
          'tvého',          // tvůj (притяжательное местоимение)
          'něho',           // on (личное местоимение)
          'nás',            // my (личное местоимение)
          'nich',           // oni (личное местоимение)
          'městské',        // městský → město (прилагательное)
          'pracoval',       // pracovat (глагол прош. время)
          'dělající',       // dělat (причастие)
          'kvalitní',       // kvalitní → kvalita (прилагательное → существительное)
          'lidé',           // člověk (через исключения)
          'lepší',          // dobrý (через исключения)
          'byla',           // být (через исключения)
          'mají'            // mít (через исключения)
        ];

        console.log('=== 🧪 Тестирование ПОЛНОЙ системы нормализации ===');
        testCases.forEach(word => {
          const variants = this.normalize(word);
          console.log(`${word} → [${variants.join(', ')}]`);
        });

        console.log('\n=== 📊 Статистика покрытия ===');
        let successCount = 0;
        testCases.forEach(word => {
          const variants = this.normalize(word);
          if (variants.length > 1 || this.exceptions[word.toLowerCase()]) {
            successCount++;
          }
        });
        console.log(`Успешно нормализовано: ${successCount}/${testCases.length} (${Math.round(successCount / testCases.length * 100)}%)`);
      }
    }

    // Интеграция с существующей системой перевода
    window.czechNormalizer = new CzechNormalizer();

    // УЛУЧШЕННАЯ функция fetchTranslation с множественными вариантами
    window.fetchTranslationWithNormalization = async function (word) {
      if (!word) return null;

      console.log(`\n=== Обработка слова: "${word}" ===`);

      if (!window.translationsCache) {
        window.translationsCache = {};
      }

      // Проверяем кэш для исходного слова
      if (window.translationsCache[word]) {
        console.log('Используем кэшированный перевод для "' + word + '"');
        return window.translationsCache[word];
      }

      // Проверяем Firebase для исходного слова
      try {
        let cloudTranslation = await getFromCloudDictionary(word);
        if (cloudTranslation) {
          console.log('Найден перевод в облачном словаре для "' + word + '"');
          window.translationsCache[word] = cloudTranslation;
          return cloudTranslation;
        }
      } catch (dbError) {
        console.warn('Ошибка при получении из Firebase:', dbError);
      }

      // Получаем ВСЕ варианты нормализации
      const allVariants = window.czechNormalizer.normalize(word);
      console.log(`Варианты для "${word}":`, allVariants);

      // Пробуем найти перевод для каждого варианта
      for (const wordToTry of allVariants) {
        try {
          console.log(`Попытка перевода: "${wordToTry}"`);

          // Проверяем кэш
          if (window.translationsCache[wordToTry]) {
            console.log('Найден кэшированный перевод для "' + wordToTry + '"');
            const result = { ...window.translationsCache[wordToTry] };
            result.originalWord = word;
            result.normalizedWord = wordToTry;
            result.normalizedVariants = allVariants;
            window.translationsCache[word] = result;
            return result;
          }

          // Проверяем Firebase
          try {
            let cloudTranslation = await getFromCloudDictionary(wordToTry);
            if (cloudTranslation) {
              console.log('Найден перевод в облачном словаре для "' + wordToTry + '"');
              const result = { ...cloudTranslation };
              result.originalWord = word;
              result.normalizedWord = wordToTry;
              result.normalizedVariants = allVariants;
              window.translationsCache[word] = result;
              window.translationsCache[wordToTry] = result;
              return result;
            }
          } catch (dbError) {
            console.warn('Ошибка при получении из Firebase для "' + wordToTry + '":', dbError);
          }

          // Пробуем получить через API
          const API_URL = window.location.hostname === 'localhost'
            ? 'http://localhost:3001'
            : 'https://flashcards-seznam-production.up.railway.app';

          const response = await fetch(`${API_URL}/api/translate?word=${encodeURIComponent(wordToTry)}&from=cs&to=ru`, {
            method: 'GET',
            headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json'
            },
            signal: AbortSignal.timeout ? AbortSignal.timeout(30000) : undefined
          });

          if (response.ok) {
            const data = await response.json();

            if (data.success && data.translations &&
              (data.translations.translations && data.translations.translations.length > 0 ||
                data.translations.samples && data.translations.samples.length > 0)) {

              console.log(`✅ Найден перевод для "${wordToTry}"!`);

              const result = {
                word: word,                                    // Исходное слово
                originalWord: word,
                normalizedWord: wordToTry,                    // Слово, для которого найден перевод
                normalizedVariants: allVariants,              // ВСЕ попробованные варианты
                usedNormalization: wordToTry !== word,        // Была ли нормализация
                translations: data.translations.translations || [],
                samples: data.translations.samples || [],
                source: data.fromCache ? 'local_cache' : 'glosbe_live',
                timestamp: new Date().toISOString()
              };

              // Кэшируем результат
              window.translationsCache[word] = result;
              window.translationsCache[wordToTry] = result;

              // Сохраняем в Firebase
              try {
                await saveToCloudDictionary(result);
              } catch (saveError) {
                console.warn('Ошибка при сохранении в Firebase:', saveError);
              }

              return result;
            }
          }

          console.log(`❌ Перевод не найден для "${wordToTry}"`);

        } catch (error) {
          console.warn(`Ошибка при попытке перевода "${wordToTry}":`, error);
        }
      }

      // Если ничего не найдено, пробуем базовый словарь
      console.log('Пробуем базовый словарь...');
      for (const variant of allVariants) {
        const basicTranslations = getBasicTranslation(variant);
        if (basicTranslations) {
          const fallbackResult = {
            word: word,
            originalWord: word,
            normalizedWord: variant,
            normalizedVariants: allVariants,
            translations: basicTranslations,
            samples: [],
            source: 'basic_dict',
            note: 'Базовый перевод (Glosbe не дал результатов)',
            timestamp: new Date().toISOString()
          };

          window.translationsCache[word] = fallbackResult;
          return fallbackResult;
        }
      }

      // Полный fallback
      return {
        word: word,
        originalWord: word,
        normalizedWord: allVariants[1] || word,
        normalizedVariants: allVariants,
        translations: [],
        samples: [],
        note: "Не удалось найти перевод ни для одного варианта: " + allVariants.join(', '),
        timestamp: new Date().toISOString()
      };
    };

    console.log('✅ Полная система чешской нормализации загружена!');
  </script>

  <!-- Основное приложение -->
  <script>
    // Основной код приложения (ES5 для совместимости)
    const { useState, useEffect, createElement: h } = React;

    // Функция для извлечения уникальных слов из текста
    const extractUniqueWords = function (text) {
      if (!text || typeof text !== 'string') {
        return [];
      }

      // Приводим к нижнему регистру
      const lowerCaseText = text.toLowerCase();

      // РАСШИРЕННАЯ очистка от знаков препинания и цифр
      const cleanedText = lowerCaseText
        // Убираем все знаки препинания (включая чешские кавычки)
        .replace(/[.,/#!$%^&*;:{}=\-_`~()«»„""''\[\]?¿¡!@#$%^&*+=|\\<>]/g, ' ')
        // Убираем все цифры и числа
        .replace(/\d+/g, ' ')
        // Убираем специальные символы
        .replace(/[^\p{L}\s]/gu, ' ')
        // Заменяем множественные пробелы на одинарные
        .replace(/\s+/g, ' ');

      // Разбиваем на слова и фильтруем
      const words = cleanedText
        .split(/\s+/)
        .filter(function (word) {
          return word.length > 1 &&           // Исключаем односимвольные слова
            !isNumeric(word) &&          // Исключаем чистые числа
            !isSpecialChar(word) &&      // Исключаем специальные символы
            isValidCzechWord(word);      // Проверяем, что это похоже на чешское слово
        });

      // Создаем множество (Set) для исключения дубликатов
      const uniqueWordsSet = new Set(words);

      // Преобразуем множество обратно в массив и сортируем
      return Array.from(uniqueWordsSet).sort();
    };

    // Вспомогательная функция: проверка на число
    function isNumeric(str) {
      return /^\d+$/.test(str);
    }

    // Вспомогательная функция: проверка на специальные символы
    function isSpecialChar(str) {
      return /^[^\p{L}]+$/u.test(str);
    }

    // Вспомогательная функция: проверка на валидное чешское слово
    function isValidCzechWord(word) {
      // Проверяем, что слово содержит хотя бы одну букву
      if (!/\p{L}/u.test(word)) {
        return false;
      }

      // Список чешских букв (включая диакритику)
      const czechLetters = /^[a-záčďéěíňóřšťúůýž]+$/i;

      // Проверяем, что слово состоит только из чешских букв
      return czechLetters.test(word);
    }

    // ДОПОЛНИТЕЛЬНАЯ функция для предварительной очистки текста
    function preprocessText(text) {
      if (!text || typeof text !== 'string') {
        return '';
      }

      return text
        // Убираем HTML теги, если есть
        .replace(/<[^>]*>/g, ' ')
        // Убираем URL-адреса
        .replace(/https?:\/\/[^\s]+/g, ' ')
        // Убираем email-адреса
        .replace(/\S+@\S+\.\S+/g, ' ')
        // Нормализуем кавычки
        .replace(/[""'']/g, '"')
        // Нормализуем тире
        .replace(/[–—]/g, '-')
        // Убираем избыточные пробелы
        .replace(/\s+/g, ' ')
        .trim();
    }

    // Заменяем старую функцию на новую с нормализацией
    window.fetchTranslation = window.fetchTranslationWithNormalization;

    // Функция для сохранения перевода в Firebase
    async function saveToCloudDictionary(wordData) {
      if (!window.firebaseDB) {
        console.warn('Firebase недоступен, сохранение пропущено');
        return false;
      }

      try {
        const wordKey = wordData.word.toLowerCase();
        const database = window.firebaseDB;
        const dbRef = window.firebaseRef;
        const dbSet = window.firebaseSet;
        const dbGet = window.firebaseGet;

        try {
          const snapshot = await dbGet(dbRef(database, 'dictionary/' + wordKey));

          if (snapshot.exists()) {
            const existingData = snapshot.val();

            const allTranslations = Array.from(new Set([].concat(
              existingData.translations || [],
              wordData.translations || []
            )));

            const samplesMap = {};

            (existingData.samples || []).forEach(function (sample) {
              const key = sample.phrase + '|' + sample.translation;
              samplesMap[key] = sample;
            });

            (wordData.samples || []).forEach(function (sample) {
              const key = sample.phrase + '|' + sample.translation;
              samplesMap[key] = sample;
            });

            const allSamples = Object.values(samplesMap);

            const updatedData = Object.assign({}, existingData, {
              translations: allTranslations,
              samples: allSamples,
              lastUpdated: new Date().toISOString()
            });

            await dbSet(dbRef(database, 'dictionary/' + wordKey), updatedData);
          } else {
            await dbSet(dbRef(database, 'dictionary/' + wordKey), Object.assign({}, wordData, {
              created: new Date().toISOString(),
              lastUpdated: new Date().toISOString()
            }));
          }
        } catch (getError) {
          await dbSet(dbRef(database, 'dictionary/' + wordKey), Object.assign({}, wordData, {
            created: new Date().toISOString(),
            lastUpdated: new Date().toISOString()
          }));
        }

        console.log('Слово "' + wordData.word + '" сохранено в облачном словаре');
        return true;
      } catch (error) {
        console.error('Ошибка при сохранении в облачный словарь:', error);
        return false;
      }
    }

    // Функция для получения перевода из Firebase
    async function getFromCloudDictionary(word) {
      if (!word || !window.firebaseDB) return null;

      try {
        const wordKey = word.toLowerCase();
        const database = window.firebaseDB;
        const dbRef = window.firebaseRef;
        const dbGet = window.firebaseGet;

        const snapshot = await dbGet(dbRef(database, 'dictionary/' + wordKey));

        if (snapshot.exists()) {
          console.log('Слово "' + word + '" найдено в облачном словаре');
          return snapshot.val();
        } else {
          console.log('Слово "' + word + '" не найдено в облачном словаре');
          return null;
        }
      } catch (error) {
        console.error('Ошибка при получении из облачного словаря:', error);
        return null;
      }
    }

    // Функция для получения всего словаря
    async function getEntireDictionary() {
      if (!window.firebaseDB) {
        console.warn('Firebase недоступен');
        return [];
      }

      try {
        const database = window.firebaseDB;
        const dbRef = window.firebaseRef;
        const dbGet = window.firebaseGet;

        const snapshot = await dbGet(dbRef(database, 'dictionary'));

        if (snapshot.exists()) {
          const dictionary = snapshot.val();
          return Object.values(dictionary);
        } else {
          console.log('Словарь пуст');
          return [];
        }
      } catch (error) {
        console.error('Ошибка при получении словаря:', error);
        return [];
      }
    }

    // Функция для экспорта словаря в JSON
    function exportDictionaryToJson(dictionary) {
      try {
        const dataStr = JSON.stringify(dictionary, null, 2);
        const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);

        const exportFileDefaultName = 'czech_dictionary.json';

        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportFileDefaultName);
        linkElement.click();
      } catch (error) {
        console.error('Ошибка при экспорте словаря:', error);
        alert('Ошибка при экспорте словаря: ' + error.message);
      }
    }

    // Расширенный базовый словарь для fallback
    function getBasicTranslation(word) {
      const basicDict = {
        // Местоимения
        'náš': ['наш', 'наша', 'наше'],
        'váš': ['ваш', 'ваша', 'ваше'],
        'můj': ['мой', 'моя', 'моё'],
        'tvůj': ['твой', 'твоя', 'твоё'],
        'jeho': ['его'],
        'její': ['её'],
        'jejich': ['их'],
        'ten': ['тот', 'этот'],
        'tento': ['этот'],
        'on': ['он'],
        'ona': ['она'],
        'ono': ['оно'],
        'my': ['мы'],
        'vy': ['вы'],
        'oni': ['они'],
        'jeden': ['один'],
        'dva': ['два'],
        'tři': ['три'],
        'čtyři': ['четыре'],
        'pět': ['пять'],
        'šest': ['шесть'],
        'sedm': ['семь'],
        'osm': ['восемь'],
        'devět': ['девять'],
        'deset': ['десять'],

        // Предлоги и частицы
        'do': ['в', 'к', 'до'],
        'na': ['на', 'в'],
        'za': ['за', 'в течение'],
        'se': ['себя', '-ся'],
        'ze': ['из', 'от'],
        'po': ['по', 'после'],
        'od': ['от', 'с'],
        'pro': ['для', 'за'],
        'při': ['при', 'во время'],
        'bez': ['без'],
        'podle': ['согласно', 'по'],
        'během': ['в течение', 'во время'],
        'místo': ['место', 'вместо'],
        'kolem': ['около', 'вокруг'],
        'mezi': ['между'],
        'před': ['перед', 'до'],
        'nad': ['над'],
        'pod': ['под'],
        'vedle': ['рядом', 'около'],
        'v': ['в'],
        'o': ['о', 'об'],
        'u': ['у', 'около'],
        'k': ['к'],
        's': ['с'],
        'z': ['из', 'с'],

        // Глаголы
        'doporučovat': ['рекомендовать', 'советовать'],
        'doporučit': ['порекомендовать', 'посоветовать'],
        'můžete': ['можете'],
        'můžeme': ['можем'],
        'chcete': ['хотите'],
        'chceme': ['хотим'],
        'potřebujete': ['нуждаетесь'],
        'potřebujeme': ['нуждаемся'],
        'být': ['быть'],
        'mít': ['иметь'],
        'dělat': ['делать'],
        'jít': ['идти'],
        'říct': ['сказать'],
        'vědět': ['знать'],
        'vidět': ['видеть'],
        'dát': ['дать'],
        'přijít': ['прийти'],
        'klást': ['класть'],
        'prosit': ['просить'],
        'směřovat': ['направлять'],
        'pracovat': ['работать'],
        'studovat': ['изучать'],
        'cestovat': ['путешествовать'],
        'milovat': ['любить'],
        'hrát': ['играть'],
        'číst': ['читать'],
        'psát': ['писать'],
        'koupit': ['купить'],
        'prodat': ['продать'],
        'najít': ['найти'],
        'ztratit': ['потерять'],
        'začít': ['начать'],
        'skončit': ['закончить'],
        'otevřít': ['открыть'],
        'zavřít': ['закрыть'],

        // Существительные
        'dotaz': ['вопрос'],
        'zákazník': ['клиент'],
        'člověk': ['человек'],
        'žena': ['женщина'],
        'muž': ['мужчина'],
        'dítě': ['ребенок'],
        'rodina': ['семья'],
        'přítel': ['друг'],
        'dům': ['дом'],
        'auto': ['автомобиль', 'машина'],
        'škola': ['школа'],
        'práce': ['работа'],
        'čas': ['время'],
        'den': ['день'],
        'noc': ['ночь'],
        'ráno': ['утро'],
        'večer': ['вечер'],
        'rok': ['год'],
        'měsíc': ['месяц'],
        'týden': ['неделя'],
        'hodina': ['час'],
        'minuta': ['минута'],
        'kniha': ['книга'],
        'film': ['фильм'],
        'hudba': ['музыка'],
        'telefon': ['телефон'],
        'počítač': ['компьютер'],
        'internet': ['интернет'],
        'peníze': ['деньги'],
        'obchod': ['магазин'],
        'restaurace': ['ресторан'],
        'hotel': ['отель'],
        'město': ['город'],
        'země': ['страна'],
        'svět': ['мир'],

        // Прилагательные
        'dobrý': ['хороший'],
        'špatný': ['плохой'],
        'velký': ['большой'],
        'malý': ['маленький'],
        'nový': ['новый'],
        'starý': ['старый'],
        'krásný': ['красивый'],
        'mladý': ['молодой'],
        'důležitý': ['важный'],
        'zajímavý': ['интересный'],
        'těžký': ['тяжелый', 'трудный'],
        'lehký': ['легкий'],
        'rychlý': ['быстрый'],
        'pomalý': ['медленный'],
        'lepší': ['лучший'],
        'zákaznický': ['клиентский'],

        // Наречия
        'také': ['также'],
        'často': ['часто'],
        'nebo': ['или'],
        'jakékoli': ['любые'],
        'jakýkoli': ['любой']
      };

      return basicDict[word.toLowerCase()] || null;
    }

    // Компонент для статистики словаря
    const DictionaryStats = function (props) {
      const onViewDictionary = props.onViewDictionary;
      const wordCountState = useState(0);
      const wordCount = wordCountState[0];
      const setWordCount = wordCountState[1];

      useEffect(function () {
        async function loadStats() {
          try {
            const dictionary = await getEntireDictionary();
            setWordCount(dictionary.length);
          } catch (error) {
            console.error('Ошибка при загрузке статистики словаря:', error);
          }
        }

        loadStats();
      }, []);

      const handleExportDictionary = async function () {
        try {
          const dictionary = await getEntireDictionary();
          if (dictionary.length > 0) {
            exportDictionaryToJson(dictionary);
          } else {
            alert('Словарь пуст. Нечего экспортировать.');
          }
        } catch (error) {
          console.error('Ошибка при экспорте словаря:', error);
          alert('Произошла ошибка при экспорте словаря.');
        }
      };

      return h('div', { className: 'dictionary-stats' },
        h('p', null, 'В вашем облачном словаре: ', h('strong', null, wordCount), ' слов'),
        h('div', { style: { marginTop: '10px' } },
          h('button', { className: 'dictionary-button', onClick: onViewDictionary }, 'Просмотреть словарь'),
          h('button', { className: 'dictionary-button', onClick: handleExportDictionary }, 'Экспорт словаря')
        )
      );
    };

    // Компонент для просмотра словаря
    const DictionaryViewer = function (props) {
      const onClose = props.onClose;
      const dictionaryState = useState([]);
      const dictionary = dictionaryState[0];
      const setDictionary = dictionaryState[1];
      const isLoadingState = useState(true);
      const isLoading = isLoadingState[0];
      const setIsLoading = isLoadingState[1];

      useEffect(function () {
        async function loadDictionary() {
          setIsLoading(true);
          try {
            const dict = await getEntireDictionary();
            dict.sort(function (a, b) { return a.word.localeCompare(b.word); });
            setDictionary(dict);
          } catch (error) {
            console.error('Ошибка при загрузке словаря:', error);
          } finally {
            setIsLoading(false);
          }
        }

        loadDictionary();
      }, []);

      if (isLoading) {
        return h('div', { className: 'dictionary-view' }, 'Загрузка словаря...');
      }

      if (dictionary.length === 0) {
        return h('div', { className: 'dictionary-view' },
          h('p', null, 'Словарь пуст. Добавьте слова, используя текст для перевода.'),
          h('button', { className: 'btn btn-secondary', onClick: onClose, style: { marginTop: '15px' } }, 'Закрыть')
        );
      }

      return h('div', null,
        h('div', { className: 'dictionary-view' },
          dictionary.map(function (entry, index) {
            return h('div', { key: index, className: 'dict-word-item' },
              h('div', { className: 'dict-word' }, entry.word),
              h('div', { className: 'dict-translations' }, entry.translations.join(', '))
            );
          })
        ),
        h('button', { className: 'btn btn-secondary', onClick: onClose, style: { marginTop: '15px' } }, 'Закрыть')
      );
    };

    // Компонент для ввода текста
    const TextInput = function (props) {
      const text = props.text;
      const onTextChange = props.onTextChange;
      const onExtractWords = props.onExtractWords;

      return h('div', { className: 'text-input' },
        h('h2', null, 'Введите текст на чешском языке'),
        h('p', { className: 'instruction' },
          'Вставьте текст (статью, рассказ, диалог) на чешском языке, из которого нужно извлечь слова для изучения.'
        ),
        h('textarea', {
          className: 'text-area',
          value: text,
          onChange: function (e) { onTextChange(e.target.value); },
          placeholder: 'Вставьте текст на чешском языке...',
          rows: 10
        }),
        h('button', {
          className: 'btn btn-primary',
          onClick: onExtractWords,
          disabled: !text.trim()
        }, 'Извлечь слова')
      );
    };

    // Компонент индикатора прогресса
    const ProgressIndicator = function (props) {
      const progress = props.progress;

      return h('div', { className: 'progress-container' },
        h('div', { className: 'progress-bar' },
          h('div', {
            className: 'progress-bar-fill',
            style: { width: progress + '%' }
          })
        ),
        h('div', { className: 'progress-text' }, progress + '% завершено')
      );
    };

    // УЛУЧШЕННЫЙ компонент карточки с показом нормализации
    const Flashcard = function (props) {
      const word = props.word;
      const translations = props.translations;
      const samples = props.samples;
      const note = props.note;
      const normalizedWord = props.normalizedWord;
      const normalizedVariants = props.normalizedVariants;

      const isFlippedState = useState(false);
      const isFlipped = isFlippedState[0];
      const setIsFlipped = isFlippedState[1];

      const handleFlip = function () {
        setIsFlipped(!isFlipped);
      };

      return h('div', {
        className: 'flashcard' + (isFlipped ? ' flipped' : ''),
        onClick: handleFlip
      },
        h('div', { className: 'card-inner' },
          h('div', { className: 'card-front' },
            h('div', { className: 'word' }, word),
            // Показываем нормализацию на лицевой стороне, если она есть
            normalizedWord && normalizedWord !== word && h('div', {
              className: 'normalization-hint',
              style: {
                fontSize: '0.8rem',
                opacity: '0.8',
                marginTop: '10px',
                fontStyle: 'italic',
                color: '#f0f0f0'
              }
            }, '→ ' + normalizedWord),
            h('p', { className: 'hint' }, 'Нажмите, чтобы увидеть перевод')
          ),
          h('div', { className: 'card-back' },
            h('h3', { className: 'original-word' }, word),

            // НОВЫЙ БЛОК: Информация о нормализации
            normalizedWord && normalizedWord !== word && h('div', {
              className: 'normalization-info',
              style: {
                backgroundColor: '#e3f2fd',
                padding: '8px 12px',
                borderRadius: '6px',
                marginBottom: '15px',
                border: '1px solid #bbdefb',
                width: '100%'
              }
            },
              h('div', {
                style: {
                  fontSize: '0.85rem',
                  color: '#1565c0',
                  fontWeight: '500',
                  marginBottom: '4px'
                }
              }, '🔄 Нормализовано:'),
              h('div', {
                style: {
                  fontSize: '0.9rem',
                  color: '#0d47a1',
                  fontWeight: '600'
                }
              }, normalizedWord),

              // Показываем все попробованные варианты, если их несколько
              normalizedVariants && normalizedVariants.length > 2 && h('div', {
                style: {
                  fontSize: '0.75rem',
                  color: '#666',
                  marginTop: '4px'
                }
              }, 'Варианты: ' + normalizedVariants.slice(1).join(', '))
            ),

            h('div', { className: 'translations' },
              translations && translations.length > 0 ?
                h('div', null,
                  h('h4', null, 'Переводы:'),
                  h('ul', null,
                    translations.map(function (translation, index) {
                      return h('li', { key: index }, translation);
                    })
                  )
                ) :
                h('p', { className: 'no-translations' }, 'Переводы не найдены')
            ),

            samples && samples.length > 0 && h('div', { className: 'examples' },
              h('h4', null, 'Примеры' + (normalizedWord && normalizedWord !== word ? ' (' + normalizedWord + '):' : ':')),
              h('ul', null,
                samples.map(function (sample, index) {
                  return h('li', { key: index },
                    h('div', { className: 'sample-phrase' }, sample.phrase),
                    h('div', { className: 'sample-translation' }, sample.translation)
                  );
                })
              )
            ),

            note && h('p', { className: 'note' }, note),

            h('p', { className: 'hint' }, 'Нажмите, чтобы вернуться к слову'),

            h('div', { className: 'attribution' },
              'Источник: Glosbe' +
              (normalizedWord && normalizedWord !== word ? ' (через ' + normalizedWord + ')' : '')
            )
          )
        )
      );
    };

    // ОБНОВЛЕННЫЙ компонент просмотра карточек с передачей данных о нормализации
    const FlashcardViewer = function (props) {
      const flashcards = props.flashcards;
      const currentIndexState = useState(0);
      const currentIndex = currentIndexState[0];
      const setCurrentIndex = currentIndexState[1];

      if (!flashcards || flashcards.length === 0) {
        return h('div', { className: 'no-cards' }, 'Карточки не найдены');
      }

      const currentCard = flashcards[currentIndex];

      const goToPrevious = function () {
        setCurrentIndex(function (prevIndex) {
          return prevIndex === 0 ? flashcards.length - 1 : prevIndex - 1;
        });
      };

      const goToNext = function () {
        setCurrentIndex(function (prevIndex) {
          return prevIndex === flashcards.length - 1 ? 0 : prevIndex + 1;
        });
      };

      return h('div', { className: 'flashcard-viewer' },
        h('div', { className: 'progress-info' },
          'Карточка ' + (currentIndex + 1) + ' из ' + flashcards.length
        ),
        h('div', { className: 'card-container' },
          h('button', {
            className: 'nav-btn prev-btn',
            onClick: goToPrevious,
            'aria-label': 'Предыдущая карточка'
          }, '<'),

          // ✅ ОБНОВЛЕНИЕ: Передаем дополнительные данные о нормализации
          h(Flashcard, {
            word: currentCard.word,
            translations: currentCard.translations,
            samples: currentCard.samples,
            note: currentCard.note,
            normalizedWord: currentCard.normalizedWord,
            normalizedVariants: currentCard.normalizedVariants
          }),

          h('button', {
            className: 'nav-btn next-btn',
            onClick: goToNext,
            'aria-label': 'Следующая карточка'
          }, '>')
        ),
        h('div', { className: 'card-progress' },
          // Показываем только 3 точки вместо всех карточек
          [
            h('span', {
              key: 'prev',
              className: 'progress-dot' + (currentIndex === 0 ? ' active' : ''),
              onClick: function () { 
                setCurrentIndex(function(prevIndex) {
                  return prevIndex === 0 ? flashcards.length - 1 : prevIndex - 1;
                });
              }
            }),
            h('span', {
              key: 'current',
              className: 'progress-dot active',
              onClick: function () { /* Текущая точка, ничего не делаем */ }
            }),
            h('span', {
              key: 'next',
              className: 'progress-dot' + (currentIndex === flashcards.length - 1 ? ' active' : ''),
              onClick: function () { 
                setCurrentIndex(function(prevIndex) {
                  return prevIndex === flashcards.length - 1 ? 0 : prevIndex + 1;
                });
              }
            })
          ]
        )
      );
    };

    // Основной компонент приложения
    const App = function () {
      const textState = useState('');
      const text = textState[0];
      const setText = textState[1];

      const uniqueWordsState = useState([]);
      const uniqueWords = uniqueWordsState[0];
      const setUniqueWords = uniqueWordsState[1];

      const flashcardsState = useState([]);
      const flashcards = flashcardsState[0];
      const setFlashcards = flashcardsState[1];

      const isLoadingState = useState(false);
      const isLoading = isLoadingState[0];
      const setIsLoading = isLoadingState[1];

      const currentStepState = useState('input');
      const currentStep = currentStepState[0];
      const setCurrentStep = currentStepState[1];

      const progressState = useState(0);
      const progress = progressState[0];
      const setProgress = progressState[1];

      const errorState = useState('');
      const error = errorState[0];
      const setError = errorState[1];

      // Обработчик изменения текста
      const handleTextChange = function (newText) {
        setText(newText);
      };

      // Извлечение уникальных слов из текста
      const handleExtractWords = function () {
        if (!text.trim()) return;

        const words = extractUniqueWords(text);
        setUniqueWords(words);
        setCurrentStep('extracted');
        setError('');
      };

      // Получение переводов для всех извлеченных слов
      const handleGetTranslations = async function () {
        if (uniqueWords.length === 0) return;

        setIsLoading(true);
        setProgress(0);
        setError('');

        try {
          const translatedCards = [];
          let completed = 0;
          const total = uniqueWords.length;

          // Обрабатываем по 2 слова за раз, чтобы не перегружать сервер
          for (let i = 0; i < uniqueWords.length; i += 2) {
            const batch = uniqueWords.slice(i, i + 2);
            const batchPromises = batch.map(function (word) {
              return window.fetchTranslation(word);
            });

            try {
              const batchResults = await Promise.all(batchPromises);

              batchResults.forEach(function (result) {
                if (result) {
                  translatedCards.push(result);
                }
              });
            } catch (batchError) {
              console.error('Error processing batch:', batchError);
              // Продолжаем выполнение, даже если часть слов не удалось перевести
            }

            // Обновляем прогресс
            completed += batch.length;
            setProgress(Math.floor((completed / total) * 100));

            // Небольшая задержка, чтобы не перегружать сервер
            if (i + 2 < uniqueWords.length) {
              await new Promise(function (resolve) {
                setTimeout(resolve, 3000);
              });
            }
          }

          if (translatedCards.length === 0) {
            setError('Не удалось получить переводы. Пожалуйста, попробуйте позже.');
          } else {
            setFlashcards(translatedCards);
            setCurrentStep('translated');
          }
        } catch (error) {
          console.error('Error fetching translations:', error);
          setError('Произошла ошибка при получении переводов. Пожалуйста, попробуйте позже.');
        } finally {
          setIsLoading(false);
          setProgress(100);
        }
      };

      // Сброс состояния приложения
      const handleReset = function () {
        setText('');
        setUniqueWords([]);
        setFlashcards([]);
        setCurrentStep('input');
        setProgress(0);
        setError('');
      };

      // Просмотр словаря
      const handleViewDictionary = function () {
        setCurrentStep('dictionary');
      };

      // Возврат из просмотра словаря
      const handleCloseDictionary = function () {
        setCurrentStep('input');
      };

      return h('div', { className: 'app' },
        h('header', { className: 'header' },
          h('h1', null, 'Flashcards Seznam'),
          h('p', { className: 'subtitle' }, 'Изучение чешских слов с помощью карточек')
        ),
        h('main', { className: 'main-content' },
          currentStep === 'input' && h(React.Fragment, null,
            h(TextInput, {
              text: text,
              onTextChange: handleTextChange,
              onExtractWords: handleExtractWords
            }),
            h(DictionaryStats, { onViewDictionary: handleViewDictionary })
          ),
          currentStep === 'extracted' && h('div', { className: 'extracted-words' },
            h('h2', null, 'Найдено ' + uniqueWords.length + ' уникальных слов'),
            h('div', { className: 'words-container' },
              uniqueWords.map(function (word, index) {
                return h('span', { key: index, className: 'word-chip' }, word);
              })
            ),
            h('div', { className: 'actions' },
              h('button', {
                className: 'btn btn-primary',
                onClick: handleGetTranslations,
                disabled: isLoading
              }, isLoading ? 'Загрузка...' : 'Получить переводы'),
              h('button', { className: 'btn btn-secondary', onClick: handleReset }, 'Сбросить')
            ),
            isLoading && h(ProgressIndicator, { progress: progress }),
            error && h('div', { className: 'error-message' }, error)
          ),
          currentStep === 'translated' && h('div', null,
            h(FlashcardViewer, { flashcards: flashcards }),
            h('div', { className: 'actions' },
              h('button', { className: 'btn btn-secondary', onClick: handleReset }, 'Начать заново'),
              h('button', { className: 'btn btn-primary', onClick: handleViewDictionary }, 'Просмотреть словарь')
            ),
            h('div', { className: 'api-attribution' },
              'Переводы предоставлены словарем ',
              h('a', { href: 'https://glosbe.com', target: '_blank', rel: 'noopener noreferrer' }, 'Glosbe')
            )
          ),
          currentStep === 'dictionary' && h(DictionaryViewer, { onClose: handleCloseDictionary })
        )
      );
    };

    // Запускаем приложение после загрузки DOM
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function () {
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(h(App));
      });
    } else {
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(h(App));
    }

    // Тестируем систему нормализации при загрузке
    setTimeout(function () {
      if (window.czechNormalizer) {
        window.czechNormalizer.test();
      }
    }, 1000);
  </script>
</body>

</html>